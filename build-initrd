URL="http://distro.ibiblio.org/pub/linux/distributions/tinycorelinux/3.x/"

tmpdir="tmp.$$"

wget -q ${URL}"release/microcore-current.iso"
file-roller --force -h microcore-current.iso
rm microcore-current.iso

mkdir $tmpdir
cd $tmpdir
zcat ../boot/microcore.gz | sudo cpio -i -H newc -d
mkdir -p opt/tce/optional
cd opt/tce/optional
cp ../../../../packagelist ../onboot.lst
for package in `cat ../../../../packagelist`
do
     if [ ! -f $package ] ; then 
     wget -q ${URL}"tcs/"$package
     fi
done
cd ../../../..
cp src/cmd/flunky/flunky $tmpdir/bin/
rm $tmpdir/opt/bootlocal.sh
ln -sf ../bin/flunky $tmpdir/opt/bootlocal.sh
echo "ttyS0::respawn:/sbin/rungetty ttyS0 --autologin root" >> $tmpdir/etc/inittab
echo "ttyS0" >> $tmpdir/etc/securetty
cd $tmpdir
find | cpio -o -H newc | gzip -2 > ../microcore/initrd-build-64-$(date +"%y%m%d").gz
cd ..
rm -r $tmpdir
rm -r boot
